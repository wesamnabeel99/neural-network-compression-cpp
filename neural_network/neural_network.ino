#include <math.h>
#include <stdlib.h>


const uint8_t IMAGE_SIZE = 28; 
const uint8_t N_OUTPUT = 10;      // 10 classes (digits 0-9)
const uint8_t KERNEL_SIZE = 3;
const uint8_t STRIDE = 2;
const uint8_t CONVOLVED_IMAGE_SIZE = IMAGE_SIZE-KERNEL_SIZE+1;
const uint8_t POOL_SIZE = (CONVOLVED_IMAGE_SIZE-1)/STRIDE + 1; 
const uint8_t N_INPUT = POOL_SIZE * POOL_SIZE;  // input neurouns
const float WEIGHT_PRECISION = 100000.0;
const float PIXEL_PRECISION = 1000.0;

byte input_image_square[IMAGE_SIZE][IMAGE_SIZE] = 
{{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 67, 255, 254, 246, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 184, 253, 253, 245, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 187, 253, 253, 253, 253, 154, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 71, 253, 253, 253, 253, 252, 134, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 0, 0, 61, 233, 253, 253, 253, 213, 126, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 0, 28, 233, 253, 253, 253, 253, 139, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 0, 124, 253, 253, 253, 253, 167, 3, 0, 0, 14, 139, 139, 68, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 28, 211, 253, 253, 253, 193, 9, 0, 45, 129, 232, 253, 253, 241, 192, 28, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 107, 253, 253, 253, 253, 87, 0, 51, 222, 253, 253, 253, 253, 253, 253, 106, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 17, 249, 253, 253, 253, 118, 22, 83, 244, 253, 253, 253, 253, 253, 253, 253, 153, 5, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 17, 253, 253, 253, 219, 37, 72, 253, 253, 253, 253, 252, 170, 114, 253, 253, 253, 15, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 17, 253, 253, 253, 203, 55, 239, 253, 253, 253, 214, 139, 45, 224, 253, 253, 253, 15, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 33, 253, 253, 253, 98, 139, 253, 253, 253, 252, 139, 19, 128, 253, 253, 253, 142, 4, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 180, 253, 253, 253, 226, 191, 253, 253, 253, 245, 45, 218, 253, 253, 253, 227, 58, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 154, 253, 253, 253, 253, 253, 253, 253, 253, 251, 224, 253, 253, 253, 253, 169, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 17, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 184, 16, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 17, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 227, 169, 16, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 17, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 238, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 1, 15, 152, 253, 253, 253, 253, 253, 229, 179, 116, 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 0, 12, 89, 121, 162, 89, 89, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}};


unsigned short convolved_image[CONVOLVED_IMAGE_SIZE][CONVOLVED_IMAGE_SIZE];
float output[N_OUTPUT] = {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0};
float kernel[KERNEL_SIZE][KERNEL_SIZE]= {{0.84763249,0.24134909,0.47557599},{0.37828915,0.76494428,0.94806886}, {0.90188304,0.49482442,0.57135601}}; //random kernel
unsigned short pool_output[POOL_SIZE][POOL_SIZE];


// trained output_weights
short output_weights[POOL_SIZE*POOL_SIZE][N_OUTPUT] = {{3071.7917092921907,-6010.178756137104,-8165.871861056815,4543.809081845176,8731.054104697861,5793.148057032178,-2939.967211808783,2463.6608503325588,-1780.8914611537264,7591.859690708278},{-7699.943201045169,2520.5950136041934,-8523.827383914851,621.7706594013467,-1466.859995901277,-7022.4076321826915,6299.739018347605,3066.2611388132145,6202.924419812443,-2781.7698982684374},{7922.200353536016,5440.334457722514,-8570.680325267234,8452.962084384637,6458.813800481095,-378.20738789361565,2603.0500708687423,-8289.424653600303,1332.7652148172099,-4432.181342582504},{-6736.1020796642915,-4009.372285383936,11008.258552129417,-6350.068537751295,-5834.8625903898,-3735.6293266139305,-2823.8165667086655,4663.7150055471575,4972.76198884613,-2073.509301243282},{-13793.950954496286,-17683.966750080683,33069.06030205248,-6246.26541605404,-17419.617717063826,-7166.224096058377,7348.574599106599,6637.763958180734,3638.8225366791385,8535.671740274356},{-31102.82391665512,-14081.434825335926,54.749768693758945,10590.204765862132,-50087.42690457125,1414.6625640764191,8246.32135127125,-8215.36987481769,720.5214202563855,-5474.986851029895},{-22291.095723899438,3927.9673802440857,-18679.256597328917,-468.1399642078711,-41249.812093040106,-19169.300152830147,12303.30832014702,1330.6683049450746,-42996.14025579124,-16827.551575386544},{-17145.05378078498,-24404.96334910861,-23534.134716079014,-2072.249260223768,-32645.23975236599,-18410.6231633718,7799.38129427309,2992.7456798011463,-56673.47786959212,-21734.54464098339},{-36201.30721934705,-33025.132313396745,-24469.39477406296,13354.891241803221,-36687.636579592116,-15597.506928267861,27230.549219783283,5634.252020098578,-46049.41696505405,-13236.500344123055},{-39009.412375867156,-12691.63132547418,-15877.566094106789,18759.95660280612,-7572.260989090647,-25828.176634697502,15540.374198503634,-5749.74622950813,-21765.9868544744,1365.0357128426915},{-37107.33839555127,-12206.501830115078,6435.786316540947,10954.642925525925,3785.077806049827,-10432.215537646167,6524.460642017227,8519.509791062355,-11176.873661113274,-5803.499219002385},{1151.8818734096292,-7451.252371783767,-2257.0413542328274,-3367.2964399293774,-6782.676271333753,-1087.9804552421717,-16236.123997750401,6178.020273293299,-1718.2662691906885,2525.628242093107},{-2174.4352658580515,-5190.685001218662,-5794.661929428825,5742.186353862202,6063.723142242181,10394.678820156616,-16537.058955592594,5597.103916065147,-3248.0727406300116,-6588.189986155816},{-6360.668988863504,-4165.623028563911,5598.218904830238,-8759.966687892045,-621.577979607632,7695.761200792611,1375.7182662919504,-3037.314309957932,1097.3343803917062,5506.416224063426},{4161.784537337913,-4801.4879598165735,19765.133760646033,716.4061776578641,980.8989126432933,-5777.579208564362,17107.33622705035,-10190.024889216207,-4943.505033368234,-6531.876062500414},{-14649.790511317173,20953.35857327493,16229.767033314833,-8980.158438580915,-3802.7084196633077,-7938.338055925607,21704.36565907608,-15331.864921615517,-2746.2805855226334,513.2052538658188},{-15537.215667774783,20851.332286128225,5336.771935959578,924.8468212215002,-4093.3943533335264,3336.3413162642864,-9265.913416543262,1152.4395452232645,170.29769235272252,-28691.817559355277},{-28539.89505720658,-7690.5962933567625,612.2563687491756,-7402.811892470432,4683.050859266384,-4846.931761966585,-4231.738507346797,-1012.2417282121321,-18695.81883171302,-9948.440374944304},{-15214.860346556967,-18612.347025178176,1144.6544715034534,-3589.7468250612346,-30122.75482469581,-18987.666026728984,-6343.735942986538,-3219.88686503603,-10617.023852838596,8457.927194564709},{13274.33791699209,-15887.661403470362,22285.375652772847,-13115.275465132867,-1272.8650252645805,-4187.487309184804,-34811.567597941095,-1703.5413727406285,-4945.137846360032,-32076.94649728448},{6592.68757089851,13605.290572704998,14053.321043399459,5740.658544509673,33025.262369722055,1156.518866979269,-31701.732120713863,-13123.454550840226,9336.16297971815,-27573.96257808775},{6713.386000010721,5175.785400267238,-7911.336689240873,6310.862645692933,-3601.4297623931884,-17373.1693971707,-362.8602131251401,-44357.09334277419,-4602.248241991302,-42073.9806117298},{2835.62798996045,-2809.7554292799946,1799.3958695349477,-31187.475541550422,-9450.575095906726,11750.527330014073,8823.029041268215,-44761.75375415484,9166.954832518451,-42018.39554392397},{56.91262444724264,-8308.74281105507,-9005.602031073358,-54934.00279855969,13969.603261545783,10740.676881650264,221.30572315740753,-3857.281145435727,-13073.735534428792,-36057.30326646595},{209.8253027546016,9409.372489192421,-3476.710409412563,-11874.954048161044,2413.27466721691,18121.745988998973,-15620.41743214854,1553.007979868839,-18580.34607228242,-19299.959788995402},{-8951.190385762511,-3530.672089775574,10347.075192513359,275.28483984521506,-6334.296773823746,2271.6171029397765,505.76242869344685,-10953.890013600327,-2694.2481763946926,-9006.025464268483},{6370.416394623004,7799.428358730144,158.6085399527866,16774.491359716696,3396.5135924145834,1119.693516243929,-3348.6578462893503,-10460.984666653318,-6045.978669943802,-8730.585767457485},{-1158.790415198856,-9456.284194836908,1256.5135031609486,13535.226608604176,695.6762807114882,-3888.4884013989285,-10313.19045446623,-6811.018618286526,-4905.1863657226095,-21145.416250448525},{-4630.351149171405,-3579.810485014959,-8625.676821741556,10281.385911462357,-144.93717513211539,-30530.92032919476,-20124.90584551128,-2067.624888084404,-7853.600229409042,-33446.88037742708},{-13108.973012757499,5587.675491451414,808.7755454862959,2139.1035212325532,-3011.1234056751287,-21538.91714687258,-8959.411984680502,7966.393206634444,-25990.9730866756,-32631.77060905437},{3867.2239514692596,-16750.336752852312,-11173.953953699334,512.2495158020375,-4137.482343069337,13413.227344722562,-10402.355316041185,-5016.67886302595,-4064.0461870073204,29998.996857301314},{-1291.9281749907395,-18582.06013021421,-18833.647436684285,30537.372753839827,5920.2190060295,-563.823807114949,-8708.008186907547,5087.490585399054,8223.35257376696,-9732.194142116774},{-4635.5791893302885,-4670.287352866872,15695.078018230146,2884.2490291410986,-37614.05916058205,576.6485116691217,6534.4779951514865,1309.0847600352142,14387.981377656946,27949.50949564853},{3919.6219689644868,-33624.90532395991,-13986.790618520992,-2062.710698523073,-13193.734888084471,-16794.84789487361,4165.501244789349,5215.570941375649,1463.197797169275,34709.19826630614},{7131.3421531328895,-13080.856796632377,1790.5640076370325,-9310.965474411527,-21909.79471125152,-7308.69707758401,-14875.174047790973,6730.950153475133,304.6591362107201,-194.85550003927747},{-6513.170149770592,7985.168466995604,-14354.56991280324,7980.758555130081,10200.258000252865,15285.289707549655,-10844.480896739125,-15948.040515906057,-4350.052025473175,16637.442792886424},{18964.40832564712,-2568.8615740562177,-7703.678140992933,4403.399997062925,8611.458133830649,-5851.494531261302,-3801.377706603036,-16874.840867989715,2684.226460564087,-12829.184886068713},{-19116.32023392508,-22525.485699367735,650.1772134128588,-8469.216400314303,24624.39135998132,-18311.242797431703,-878.1676271583731,-24913.117650179272,5601.190824463302,-22581.705787098945},{-14582.405350008887,-10714.728505778618,-14214.849122628942,-28143.749404382546,-15898.577083472279,17855.176293137643,6786.101971835143,-5016.934088933074,-18222.429627973805,-26723.64869848036},{-7803.477556674588,3368.5948491081003,-11275.073427679352,10333.940273396356,-11163.850197135896,-8957.025977554635,6135.65485121137,2607.3122152168903,-11128.367956933154,-3294.956597851229},{-7575.375340018664,-6211.351393762351,14496.767850574628,745.0564673383047,6852.583291438567,-28862.80765515286,-12188.793052832358,8265.765385209841,-10581.361657645419,-25381.414543337087},{-26381.594514205182,-31638.498865008696,-17156.374947295666,943.5601021158271,-2845.332554335007,-30094.373556806157,-8132.255421229173,34216.64311732881,-5475.988522624075,-20093.016117079624},{-12122.588637497445,-43734.33005933358,21905.906256568487,8904.723785872775,-3930.2008093055424,10448.661539269367,-18661.006420181195,24122.48654910111,3670.153036724248,-9031.142142707555},{-6693.903917561481,4393.316188670964,-1218.128680222026,-14939.40486930333,-8397.020521331602,4645.331967119593,-17606.583453762378,5367.394217641717,7702.833810396443,-18260.30698667013},{-8368.352551756418,-7740.7144426242085,23168.576731703095,-3411.020854117895,-16972.995645172614,-10618.330696393186,-9343.937663699708,-1430.5095480859757,-1100.235793959858,-6244.192079703048},{7673.138782616787,-15350.809072903003,-8642.183900008033,-15825.739051993967,-32700.2531658765,-6782.535153107035,-2220.772851007472,1738.831239030903,-34170.014887746525,17397.4927028515},{4501.607363349821,-7944.349589102987,-6175.635190780072,23049.638156067802,-1459.225735266514,-10780.019768373642,-18478.836014887514,-4033.9317762142077,14286.44622169973,-5094.02152335088},{17281.86241132157,-20660.503324770994,-7599.1086795978945,-4570.395133634158,166.57155455216687,-22131.123570990436,-23826.011667862957,10833.233895749701,-15853.733010884489,9756.613254419015},{-5235.0566630888825,9910.15906330856,3064.102198704633,5628.5564334436585,-12892.630946938742,9127.570130749005,-29090.69319985666,427.24789496878196,-99.21527025954252,-26786.67571603771},{-14581.802637108707,-22898.22597077908,-2899.6873364486146,-5147.290144317506,1623.7391783632063,10926.68406831797,-14179.088080190772,23382.523945878394,4070.414341674028,-8555.18909216033},{4271.751322624261,-23382.741982600484,-26455.590500270424,-25641.60382323528,-10069.496649790557,55080.45763945777,-34834.87169995433,-8805.145519788573,7338.4847508467965,-28971.013636026262},{-23023.275300780584,-14041.752985112314,-19467.398967282043,-26230.45875798258,-9944.225558422211,65176.30711856543,-20748.8747711946,-399.41450841951695,-16710.643848339285,-36573.4771644548},{1505.172129830808,-94.41706134566418,-14021.569037564775,-3913.310405574853,-22208.694388084816,-4998.076007645549,115.1362577783714,16021.06113128482,-6260.088615969749,-17029.078468781197},{-13018.519562706975,-9330.244614299352,-4050.6463636100316,4781.060343538601,-19210.50755007991,-19211.398909192,-920.6940581267853,19073.147763936722,-11498.240730802121,-30831.88659283312},{452.8122483010782,-7206.654640273611,7378.163371175753,-1931.4431476109096,-19015.43913546341,17234.456465641782,-15424.132478244355,-6788.4802352101715,31713.397359384642,29791.162813843843},{3397.119998563536,8902.538948697353,-16634.844870728935,-16051.074340825826,-7751.847810413335,4348.059326975031,14573.387696846019,11031.07218016094,6667.528167607744,-2114.1983810056577},{4325.70278259729,-12164.782302531372,-40151.912471342526,-9620.876497122412,3513.502347705972,9789.044767804533,3176.919501249783,-4918.994121722931,19424.806751643933,20906.91167010852},{6653.520809693418,-12075.33930566983,-11598.219411132493,-19600.118119200808,4884.387598523003,38522.79845682335,-13552.014253968391,20652.748320857798,13565.358771771587,-738.6149813656466},{-23568.108883462206,25836.88905132166,-32071.098637268216,-110.69831941906824,-21669.1029934788,1527.3429798685918,-4908.41311471899,7573.825911191381,6115.847066924925,6793.41833550113},{-1730.4009373341285,21421.037855113645,-10134.767813975339,18815.921006298144,-14767.413119433892,-11042.798988277165,-2532.6459361015573,37467.720913826786,-33421.893512312636,-16448.09354493383},{8919.645898480567,1599.1553164921468,-8110.121437059343,20997.587841293633,9822.119419570823,-26823.729544428697,-46862.8181779474,14175.988308182279,10086.525945864629,-18077.83102704297},{7453.87431691423,-28418.403133041815,4240.085486509639,-3753.3256633266333,-20846.757848014175,-23067.877307056417,106.39224608199427,178.49149597560492,14926.26178785287,15314.624873600276},{5423.755296971312,-20437.843956523204,15493.844153505484,9139.933171668852,6580.586078382731,-56236.85078426668,-6614.8784175083965,585.5613398681431,20644.050437167178,6138.888634266747},{18492.889713496355,-10266.268754930312,-17040.03133559261,4756.077343929526,-2982.6241138706537,-14696.304637432671,-15470.704312587071,874.2880073259162,24826.280855985264,3486.2226282530096},{-9304.242098585315,8576.149981922434,-11983.327472401834,-13107.920151531485,-18151.207926063867,41969.300500844634,4445.199225468287,-10940.185705936332,-32037.923072518217,6072.327586397636},{-8373.863267113267,6627.810938676191,-2120.322913032676,-12492.176883671842,-17197.238965043252,-6803.832895685599,1003.8377209462085,12102.42816531808,-11655.370689131361,-14120.587605775798},{-8279.629178014597,-3036.3038962099254,-17330.3567064491,-5748.5295178793385,-2251.9831009334453,-9239.096497296874,13506.555309101132,335.6645754199422,-4841.4686685079405,1805.3085206931164},{19148.74826601894,19830.409215460524,-44545.932795526176,-10934.53656366836,5644.209841998439,32731.06849367461,2568.5285601350315,-34091.17870251301,22675.99511658799,35175.431068669495},{3227.4370648572863,3019.017873572582,-40540.48796633912,-7291.722761715881,20239.623627230216,14872.568821457908,25057.265661102196,-3458.966691518437,5525.799470517726,-467.30392017787875},{3156.5708643237285,-29156.483832484268,-22091.487702940663,-36448.8682312534,27842.133441405844,-19420.88215100035,12500.855067388633,-11034.753510698596,-31287.613600330445,26057.763671490695},{484.15244803194145,-10750.080297501663,-36139.06794969987,18084.98910362171,21833.75911575943,14861.943688990556,17914.694367628992,-26844.141320775667,33014.40249983017,-8236.120255129248},{-6282.896539274116,36509.22252611676,-30288.391288154427,15884.303894193212,-2460.9517722757605,-16005.982143487689,3600.1900243192204,-8712.266316801362,-1248.3574228781858,566.4259636234484},{-38804.861662248135,14838.361735946179,-2294.1851521217627,-9808.889529554584,-13080.377449692909,2137.738802692284,-21300.65305753017,8043.9815817386325,3400.4427485376627,13000.061161521266},{-15410.997780484533,-2534.6382636833387,-8348.860373968038,6622.653018494419,30729.220596747517,-26856.333158577738,-711.3541584332321,18177.56067109532,3656.15150448532,-5912.942373809527},{7725.795887684395,-6062.378632524702,-15619.887076056602,19930.895796967652,-7000.669575669436,4266.440853136925,-13505.140503939541,-12851.98262910566,-11568.69813113594,7153.567176940894},{106.21250722585155,-19103.64798060844,11788.9037022406,-41713.75548498733,-10312.96862658682,-39939.16590055677,27865.029730632545,12997.692740879125,27637.792634717574,6563.470235645646},{14889.069627892748,-435.4900308169159,-32391.310838649977,-23947.805582437995,-12895.053763843767,-67901.8573036777,8723.670862166506,-8582.649498216044,28103.528205929855,-803.2938163721649},{-10525.038616359543,-3827.5889481973873,5897.917268245465,555.5294480372886,-9210.10478147307,-10207.369398645671,15357.560346588885,-19889.583696353613,-5841.6187326395775,-12774.331719066651},{5109.93667706859,-6465.944537537147,6804.9605832910665,-5246.913881651697,-10974.76270170548,9362.55753582905,-10620.24195747703,-6936.396603421252,4000.995051299543,13189.194025505418},{-1651.0226279693322,10402.233399940435,-3216.1341787734054,-10409.403733979554,-4589.520822467828,8818.387821247477,7613.582804582473,8658.083672639426,-14558.342114327152,1210.5245181862801},{13591.793559924918,5988.371377895639,-4618.391214500421,-54488.094565504194,26247.174794184644,-24762.900544012486,-3476.2248116888577,7869.997021480114,-43493.49408569904,-5844.319878990487},{14261.727295197754,-9194.07124211169,7911.761064533045,585.3434578201892,-17081.134256124744,-13199.58662232252,11193.982114997869,-13618.417467691952,-24778.39720359473,178.45443480582213},{-13943.06488480235,-36820.232901233154,11627.934030429347,15976.08543580022,27013.41344173864,20167.108075904227,-10741.251156760336,-6996.032020328175,-28510.315608559355,325.60947811976456},{28351.73832514361,3999.953119095021,12625.784675007799,-2385.090318610633,5434.21176217475,8618.438822349162,691.0472114633117,-30950.653617719017,19777.44139406083,10095.564743117633},{-37123.296108805334,-3230.8459261857115,7818.46953962361,15157.566107591352,3877.943723204433,-491.7459373604287,15642.57153829869,-30465.541858590102,-4768.695213550624,12240.04916994501},{-45848.619720532915,21249.88984949215,-27714.348868528872,-16481.035658433295,-9612.837654632829,-13680.676355662756,18167.94778371697,-7454.992827495521,-1358.1798625167808,-23162.387528362215},{4785.628986692805,4149.803414810566,14728.428836210624,1032.343065346629,27758.908975612834,-6088.549194986646,-12081.041204509147,-7385.969320652302,13402.02426272586,13210.610630304298},{-5603.769986438473,-23585.307743228375,-16244.992197395959,-31173.998179667135,-6490.786016569009,17906.75421174509,1385.096121880022,-376.72426502997104,-24819.767695392533,1747.6914394039916},{-12023.608782963809,-8048.636382035049,-22129.73496048856,6158.998710825641,16161.872776674627,-13339.726898983583,12865.635315174091,14100.584230903365,-24642.551706763104,-2440.17474977578},{16998.69835957049,7320.480075371723,-18896.90553301719,-4600.135326501736,-15789.374847895479,-49786.12445720958,23923.08850602454,-7140.114845442333,-12987.778865490793,-20760.167443452363},{13723.123573578356,4407.17544548173,8506.535247336786,11626.045422683044,-23528.654715798708,2852.999731012833,-10318.444015066852,2701.1092896369005,9903.716081460243,-22971.215662264636},{-6132.6227185227535,-3108.5453352033787,3840.9490589085103,-5520.839388954238,-7904.812142945393,1548.2147197240477,9067.039865538778,-9697.77955575514,1111.4082730578502,-586.0998760132271},{-5024.462399650217,1680.3786466035033,16192.999407784848,-1661.5627605108552,-22100.633018341163,-13944.087633283232,-7535.9314605236095,5268.830283461148,-19227.404480314828,18255.94512965167},{12351.593187925719,2137.1349889513135,225.96527699509105,-4623.919332544729,2771.760455189731,-716.5172355746525,-33409.901459825385,26812.904240574015,-26853.426083919923,-10466.390658056744},{15501.864321165634,9497.362733887177,-2162.274412216363,-17041.41393619505,20106.28182275396,-21927.42800246559,11460.767802985143,3844.070651350896,-5738.918165946307,-523.1149403023529},{10193.963526169264,-17076.976358872747,-13013.700653252372,-11633.256864983026,-2091.869505884598,-3503.8224826544993,30532.628199342824,4834.330004951553,10092.375861739973,13083.314696572397},{2169.0658429188393,-1574.1143251325557,7346.972537752418,-18487.145200102852,14959.92328362271,-14694.182088158914,-3081.314431200997,-2932.161189277799,9277.62562133998,-5873.460949849025},{-90261.76014689241,21501.408146147995,14046.927534800781,-7361.263561326068,4616.600263863532,-10654.187380857351,-1305.3118944469838,-21077.03177347661,-13753.668033990094,-17775.407387395127},{-15981.718205480447,-10517.747471177936,-11255.942630609474,-12451.323613874856,5984.437114543128,-9654.283947622305,-16708.538805995013,-7006.787130164686,13855.550630865779,9633.061880658119},{6556.140902466989,-21106.84496046413,8526.455780886845,21154.255766495295,14555.09462045991,-17297.092239644426,-10539.79281580987,29408.468903552155,-37451.131521689975,1021.2957957570163},{1568.8942851042173,-36073.4025638431,-5167.687873548704,6236.14755226949,11583.015792664033,-11878.291461198556,-908.5694371068191,19029.051019227783,-7136.4006281110205,-25309.273662435382},{2724.5261954839743,-4683.929170322786,15376.80453572306,17497.146950351795,-5762.484468345258,10112.372936302452,12854.578131706983,-10514.521601824556,15036.28746484438,-2897.264626308389},{16566.204663806682,-1217.360300330482,16120.070771372297,-6625.8874108800965,15237.395689483334,3791.902108296514,-4849.062363742618,-25488.47975489252,-30155.752625616078,-49908.734658343},{13033.291685838005,163.72841319983556,17535.245139658404,-3877.250599575648,467.5625694892868,-3327.509608567468,-21034.66918634308,-3955.5799899383433,-51.04106904200744,-7060.298578211731},{-5302.193603731998,-5167.983163893417,-15786.611366242907,1455.0495450175715,-9343.475617141616,5879.574266263392,867.2288602048102,3767.6923192871595,-12145.735843875109,1073.366240787152},{-21623.871504818682,1441.937594609143,-11820.487791557243,32923.25484617295,-28930.530308268924,-22456.012991388663,-12688.279089249421,16144.455624372209,-2841.5927212781207,-13087.428009069276},{11392.974789978327,-27386.852369279317,17376.33082385922,3196.487842704616,-12480.583770771138,31008.217850656372,-12117.425142906573,-1805.5653341834695,-12536.070160948228,-14735.885205392096},{-964.9567043920705,-26209.985468840372,15712.373917793426,755.3444901628803,13218.0030011312,-11172.87183783536,-8281.666732243839,-37396.46892619974,12741.812215681342,3398.7847217762105},{33459.04976554243,-27466.072009721003,11376.084009984093,-13973.04617692239,-3420.7059166791005,-18154.057486310157,45434.78822052076,-19257.263370222492,12810.22757582479,5224.768389759056},{22726.475698239123,-1413.8423803052635,21225.554104917723,-42075.334212157104,-15085.041648361326,2487.0147933191056,11786.212794491266,6429.456327620078,20703.305180634274,1295.5149915320694},{-38196.95347767421,33122.852005696084,2809.41112683814,-12329.654172069673,26378.99148772233,-28905.471218820334,3298.6028833650403,16147.92576580389,-30775.937393655455,-15471.327472996833},{1668.1145587751355,-6945.148967588204,17035.00766351412,-22880.71089122538,17118.789006697312,17741.801480132985,-5901.019175185445,-12820.83473997216,-9905.364100486666,-10208.59818879735},{5645.0126426583565,-5358.96034020695,8855.169755232755,22701.277534795085,-13678.00607393322,25885.7362758989,3957.3608520905714,-28753.245507203173,1649.4580301230005,-4307.435292829011},{-2034.315562301623,23216.364636540315,-26177.10053832694,-19134.674326981207,-13082.743346519328,-3512.2058551658047,-11426.216455816075,12621.489913471798,-23970.147213541404,7833.352942875934},{-5417.777759921668,2452.7837160438244,24547.985118164383,8815.391345949065,-8440.695732651591,13252.015244288266,-22086.100300980932,-22571.060000957496,-16520.62156830613,-7614.143326198408},{8896.885595353273,-5890.575889237595,9255.75960238215,-26996.808217854155,-3941.0190909484872,2960.5202338530567,-10502.547926924639,-10336.133836822348,-550.2845795526421,-14677.697801981181},{-9640.799262798762,9829.09909919543,4402.349234160451,-6800.810331026903,-6822.963558369969,-23798.351545215795,-7419.248769377421,-3684.0900303003477,-16225.421191883797,-7116.739613882589},{-368.7897407317773,-10172.775127021983,-14368.300940915953,-9710.350087116025,3261.352972901364,24268.992152450413,6883.605624012508,-6671.806828176316,-5891.8522236629,5840.898388326754},{-30219.026770862965,-17226.848334228845,-3068.855133868827,39055.01830748533,-6664.63746099117,-9440.923924752302,3600.3600100111466,-13698.21115164828,-11519.910761793297,-12270.051678451675},{5301.663633727501,-684.9147494015674,14845.209594136097,14562.390756473487,11811.512899818177,18540.76185620335,-22777.40701525465,-30386.743903990166,11043.74338759175,3.463458437837293},{-10547.604070383964,4228.449490734338,7505.508173948431,4482.06775999972,-36459.66462830709,32223.684417390472,-25351.785275098737,-15159.671458762516,-11993.58811197368,-3804.450267215335},{16862.167594238705,6668.282764867856,4118.966446287995,-12433.417124090533,-39820.62948142953,6055.470695505216,14708.31724086854,-6680.417914039275,13369.694096609375,-19038.514506294432},{9773.72125264362,-1944.9988476908006,14798.95693355236,-4490.234673385796,-7990.1394055985065,5957.017266566534,10322.148379907543,16123.000756242587,-24657.229828786792,-1597.348104130329},{-18735.793038179097,5917.076387954096,-6982.14015986999,-12537.194370953908,-1188.6546012901952,10761.455686006902,8723.080990140728,-20165.18396584606,-14508.998044342321,-6882.641318457676},{-28553.59695143804,-12880.797681453963,3123.1780251314035,-229.4269105848929,-6568.785337995729,-19676.813517321607,13383.644312980914,3787.204844654846,2399.203405034385,-18941.628004017184},{-8094.816514862986,-1457.489108093491,8314.538198666203,3511.5804790931247,-17632.08686991357,-4560.871334124565,12479.230110770088,-24253.69253793911,148.1465295042709,-7200.236233389229},{-20312.646437731484,2964.7258873104997,2743.0553399812047,-938.5948836716819,6684.7269238593935,-1393.9037485307758,3140.74613626586,-25370.358351862717,18707.84139520665,1864.48961015573},{-13492.829131584786,-14182.82123035011,33761.14780718633,30266.262523481397,-16958.84206761394,14424.538323720266,-10086.122147561051,-11997.144470099302,11942.912431586881,-8737.133970308394},{-5559.463879627327,11938.916479942982,12517.227757859204,-21600.8648044168,-12403.142445049405,-3770.651058444177,4600.414054000558,-14779.225581383856,-3311.604157914685,10564.128795837501},{6909.013260478268,8455.559189827352,2608.852635091189,-16453.815978800212,-16333.85022344481,-6728.249291266557,-7214.57673037817,1503.6151396154298,-1639.312528468263,13266.733229527485},{8428.541363613345,9087.007415421222,9183.444154015353,11998.867488617541,7836.172722812484,-9653.55572970874,4830.721826942262,-1866.4438571980027,-484.0198276963413,-111.9249533271839},{4971.414425008711,-4440.892786419313,2401.143672699555,-176.01513236663382,-2893.754783273773,3326.612421362155,-9672.269523995867,-8676.580985039385,-48110.89156829101,-10838.046054604123},{10738.08772325363,16231.627662915635,15561.986113177682,-12243.980915203145,-12237.38635565758,-13671.684155094199,-8965.764663890508,-15549.009168270364,18202.334298197446,-262.5294834283096},{10809.665983436149,11447.982877624636,-19045.98868029528,429.59308080624476,876.5514173325537,-14994.790318645088,14488.026761464685,1594.1345464105993,1080.2753991660888,-2377.587480743899},{7005.618548587866,2769.333310295706,15772.672275560455,13375.680756527154,-2520.700796453521,10115.06913083509,920.7504592617001,-7955.156774080801,-37757.89859732991,4769.282935179115},{18425.43345073034,-17105.17490900845,9512.533226463784,-11339.646965485888,-12263.159515359985,4680.476075032595,7356.979151930968,-7984.422596433115,11760.162318392051,-1155.4939596719764},{1405.9037426043674,-11194.019580130958,-3584.332279558247,1532.8012134560922,-17118.820804892453,2411.025036103519,6361.832057727011,3542.754604369108,20132.190345479583,-9125.407378885484},{14263.234701900948,12988.586187086814,-37794.51778989121,5142.407031171582,-6434.245577898631,1508.2871820304663,-2531.0852655898348,-10280.308695725833,-21276.10799758799,-5163.62379698756},{-29100.61280150153,6876.7985145089315,10756.285270815733,-8046.59838056446,7005.777630046521,14791.556355079203,17710.726931106106,-3406.387012247728,-6593.899491080091,-22165.88754119123},{-11061.732104582241,-9266.866008206842,-6007.602844039137,14359.660013278406,9782.49031845545,1555.5830465872875,3555.4677157664355,-44178.90383224163,14500.24652189977,-7079.491139885959},{15145.066765458489,937.6968273751165,-3369.0916133955934,18978.11198504152,8063.276763287643,9742.526217599729,-15106.133718059255,-22356.957955784936,-16100.544753769584,-13075.589240136163},{-14186.360018358835,-5276.571553512702,16287.735763743123,-28441.449568023672,6290.983874248458,18549.009423486772,-20178.103601051855,-17170.960142358428,9512.38647471669,-7369.102535863645},{981.2019847320277,4638.528546493302,-7800.912192389994,-9370.170569252059,1846.1843744424843,3384.0684625007557,-2751.2332345068926,-5770.576618743853,-1173.5406496869093,-13955.411076549039},{-1024.7843247509059,9766.339426033983,6303.182734169594,7069.447963430434,7026.966193670554,-5700.408996059683,2994.1483491791273,-8870.62831167578,-2214.0427998194928,-9913.917105343899},{-3771.452354093181,-7557.957912872382,8514.404829260593,39453.238195332,-9101.846573321813,-7608.261966053006,-7617.441861792498,2635.6647991808295,-19925.87179445164,-3676.0632098558804},{-2393.288876842033,5251.330782299953,-11520.828578276856,37260.42550040089,-9952.77435517728,7567.883994997689,-5551.1686505848975,12998.464829534261,-20110.4776971258,-8740.553726863713},{-16351.363039244688,2924.686976400897,-3227.71613471172,18537.754162239304,725.1915075194802,4861.109941115903,-38062.57804654914,888.5798442010306,-13057.214500755817,10004.241073300178},{-3756.777240462393,-21254.048953661102,-20310.771065712393,-3675.9286739155104,-10759.010817789791,-1007.7798597734978,-45735.600988192,-942.8944972966285,-1842.0858869585193,-13426.157776197222},{8593.371520720417,12625.813498981304,-10306.57066366855,-8552.484281547759,-5041.698722916626,25071.76585027973,-54803.17405339041,-1155.6146850376877,10519.631484376529,-14494.75286989588},{1063.0907277789336,-6026.5910181615745,-10683.438618952534,3313.40646753055,-2056.9836619937796,5649.567654440243,-30573.526486755225,-11177.328756276172,-7894.085496437026,-10306.610087465298},{-14601.736073470523,5166.041828718146,8998.97320847903,-13291.697527949511,3666.7942366015773,10290.253292256477,-46430.329772413366,13495.402248279706,9523.682915872576,-14923.257430273963},{-28697.63250088876,4484.416722799901,23824.044776654653,-33439.72010135487,-7024.735644830334,-6921.503310880924,-36520.00260236663,-5534.764216317481,9350.304993703958,-8547.239686844565},{-2063.7496818907725,2111.7028884822394,17901.242907395474,1331.80840328283,-15797.310768470134,-8124.689040328324,-16903.876113312042,-33187.62965907827,-14036.25784552233,2209.9496447227825},{-11470.809612527384,-10700.438452938375,20283.937646980372,-18189.818661215613,-17474.946785217362,-11346.720655192295,-18527.60175665798,-21940.452373788685,3507.278456414927,39225.04899820912},{1550.41541380393,-1492.088680629135,2635.198788657431,-25560.94268585861,11730.525284047248,4875.70159196648,-4078.4144712755383,-12805.86995062493,-5128.60025828042,15278.894924999535},{3460.8834376147497,7700.034240698196,-9127.256363616758,3284.394279365863,-3054.1607954999777,-7347.360350588129,-319.27888073924424,-4452.897981698761,973.3400398051591,8908.470870080651},{3652.8000667707643,-3509.189115007999,3079.190531445992,2263.245842681245,-3355.3425675196286,1434.2341663340158,-1792.8183197196788,-6423.181416020774,102.96636655820784,7287.452020307876},{3264.775228022458,5805.492590852555,-5453.541413267797,-5784.824940027816,7806.070574785296,2508.3481506028425,2335.112681581908,6065.299625808349,-9086.19998075063,501.9381884549267},{-4741.489316949794,-18297.925192713017,-3754.725272722082,-17551.05935716306,-7755.656594818283,-7937.30995455712,6635.333177831863,13139.045732401928,318.9853829457366,-9161.053545814217},{-24530.050410426004,-20099.730732126518,-6221.523260127514,-9465.834098664393,-32112.443244813323,-16352.043063163597,-1374.6366602757355,19328.96503346754,-26059.988130213053,5180.665637645585},{-20407.39845388813,-22106.556565918592,-15615.258171749729,158.30178979336392,-31171.64400012542,-6048.248033490488,4055.016509080566,3124.8217142289736,-53334.67165201544,-1583.7659154554262},{-29401.185929765405,-38696.29213206674,-20666.16719361933,-28993.757552296513,-37934.04992092098,-15156.494237799987,-4127.703982723229,20668.410462751875,-51827.28258520625,14109.453095540774},{-24398.92830288358,-22808.724407771857,-15513.491751077601,-20911.87073526869,-25353.07214667286,-14988.876876074268,4016.0218834556917,7254.613629667305,-32204.43490500108,6678.890152485473},{-14633.840542853573,-19343.108170239062,-11111.292023601727,-37767.97751098523,-41539.89831389241,-860.9573112958112,-10053.758544023638,6140.2577914566555,-45019.97736059374,10381.436275386272},{-7470.086572929333,-3726.729586195304,1612.9597259793593,-5147.936730220118,-41359.389201230755,-5315.164880879951,-5211.039677825846,-3143.2269529685695,-36110.848075819194,31842.93571739818},{-12632.482409476639,3525.365749092614,-16280.7964109803,-1105.7525689988133,-22272.663531442806,-8080.90142651971,-2601.4485333885095,10024.326882067997,6409.527242439394,1662.3834313952584},{-9273.88171277004,-2417.84362858769,-16680.476550097108,13601.898647457063,-19905.46057746826,-6278.723055645302,-9565.95708928177,20406.01151864806,-947.492855187527,-2797.439596544893},{6641.238258590399,-1383.6851130538014,-6438.84885282586,-8398.989099363309,-13710.68646211226,-11452.349328783877,-6605.141672363047,4358.983744164775,-53.09274994970551,-4584.111379778403},{-919.0373032077304,-6054.455793037559,8313.98181515579,-9973.090769495668,5629.930538751453,-9664.08375531774,-3999.780384004734,-9421.572689248875,4012.9483492656814,7125.9684052465545}};

float sigmoid(float x) {
  return 1.0 / (1.0 + exp(-x));
}

void setup() {
  Serial.begin(9600);
}
void loop() {
    classify();
}

void classify() {

  convolve_image();
  max_pooling();
  forward_propagation();
  print_output_vector();
  
  int winning_class = find_winning_class();
  
  Serial.print("winning class:");
  Serial.println(winning_class);
  
  delay(2000);
  
}

void convolve_image() {
    
  int compressed = 0;
  int nonCompressed = 0;

 
      
  for (int i=0;i<CONVOLVED_IMAGE_SIZE;i++) {
    
    for (int j=0;j<CONVOLVED_IMAGE_SIZE;j++) {
      float sum = 0;

      for (int k=0;k<KERNEL_SIZE;k++) {
        for (int l=0;l<KERNEL_SIZE;l++) {
          if (kernel[k][l]>=0.4) {
                      sum += input_image_square[i+k][j+l]/255.0 * kernel[k][l] * PIXEL_PRECISION;
                      nonCompressed++;
            } else {
              compressed++;
              }
        }
      }
      convolved_image[i][j] = sum;
      }

  }
  
}

void max_pooling() {
  
      for (int i = 0; i < CONVOLVED_IMAGE_SIZE; i += STRIDE) {
        for (int j = 0; j < CONVOLVED_IMAGE_SIZE; j += STRIDE) {
            int max_val = convolved_image[i][j];
            for (int m = i; m < i + STRIDE; m++) {
                for (int n = j; n < j + STRIDE; n++) {
                    if (convolved_image[m][n] > max_val) {
                        max_val = convolved_image[m][n];
                    }
                }
            }
            pool_output[i/STRIDE][j/STRIDE] = max_val;
        }
    }

  }

void forward_propagation() {
  // Reshape the 2D array to a 1D array for input to the neural network
  int flattened_input[POOL_SIZE* POOL_SIZE];
  int k = 0;
  for (int i = 0; i < POOL_SIZE; i++) {
    for (int j = 0; j < POOL_SIZE; j++) {
      flattened_input[k] = pool_output[i][j];
      k++;
    }
  }


  // Feed the flattened input to the fully connected neural network
  for (int i = 0; i < N_OUTPUT; i++) {
    float sum = 0;
    for (int j = 0; j < N_INPUT; j++) {
      sum += flattened_input[j]/PIXEL_PRECISION * output_weights[j][i]/WEIGHT_PRECISION ;
    }
    output[i] = sigmoid(sum);
  }    
    
}

void print_output_vector() {
  Serial.print("output vector: ");
  for (int i=0;i<N_OUTPUT;i++) {
    Serial.print(output[i]);
    Serial.print(" ");
  }  
  Serial.println();
}

int find_winning_class() {
  
float maximumOutput = output[0];
  int winningClass = 0;
  
  for (int i = 1; i< N_OUTPUT;i++) {
    if (output[i] > maximumOutput) {
        maximumOutput= output[i];
        winningClass = i;
      }
  }
  return winningClass;  
}
